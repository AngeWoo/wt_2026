<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>點點心連心</title>
    <style>
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        :root {
            /* 彈出視窗的色系 */
            --modal-bg: #F8F4F0;
            --modal-content-bg: #FBF9F6;
            --modal-accent: #C8A987;
            --modal-title-text: #8D6E63;
            --modal-text: #5c5248;
            --modal-border: #EAE2D9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* 全局防止縮放 */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #F4F0E9;
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            min-height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            /* 修正 2：禁止雙擊縮放等觸控手勢 */
            touch-action: manipulation;
            /* 額外的防縮放設定 */
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            position: relative;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            body {
                padding: 0;
            }
        }

        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            margin: 0;
            padding: 0;
        }

        .snowflake {
            position: absolute;
            background: rgba(117, 92, 72, 0.15);
            border-radius: 50%;
            animation: snowfall linear infinite;
            opacity: 0;
        }

        @keyframes snowfall {
            0% { transform: translateY(-5vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(105vh) translateX(-30px); opacity: 0; }
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 25px; 
            /* 改為 100% 寬度＋置中，避免左右偏移 */
            width: 100%;
            max-width: 450px;
            min-height: 100vh;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            padding: 20px 16px;
            box-sizing: border-box;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .main-wrapper {
                gap: 20px;
                padding: 16px 12px;
            }
        }
        
        @media (max-width: 360px) {
            .main-wrapper {
                padding: 14px 10px;
            }
        }

        .game-container {
            background: #FAF7F2; 
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            /* 防止觸控縮放 */
            touch-action: manipulation;
            margin: 0;
            /* 移除 flexbox，使用簡單的 block 布局 */
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .game-container {
                padding: 20px;
                border-radius: 15px;
            }
        }
        
        @media (max-width: 360px) {
            .game-container {
                padding: 16px;
            }
        }

        h1 {
            color: #755C48; 
            margin: 0 0 10px 0;
            font-size: clamp(2em, 7vw, 2.6em);
            font-weight: bold;
            display: block;
            text-align: center;
            text-shadow: 3px 3px 5px rgba(161, 136, 127, 0.4);
            width: 100%;
            padding: 0;
            box-sizing: border-box;
        }
        
        h1 .title-icon {
            display: inline-block;
            vertical-align: middle;
            margin: 0 10px;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            h1 {
                font-size: clamp(1.8em, 7vw, 2.2em);
                margin-bottom: 8px;
            }
            
            h1 .title-icon {
                margin: 0 8px;
            }
        }

        .title-icon {
            width: 25px;
            height: 25px;
            color: #000000;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.1));
            display: inline-block;
            vertical-align: middle;
            margin: 0 10px -3px 10px;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .title-icon {
                width: 20px;
                height: 20px;
                margin: 0 8px -2px 8px;
            }
        }
        
        .instructions {
            color: #A1887F;
            font-size: 1.1em;
            margin-bottom: 30px;
            width: 100%;
            text-align: center;
            line-height: 1.6;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .instructions {
                font-size: 1em;
                margin-bottom: 20px;
                line-height: 1.5;
            }
        }

        .memory-game {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr)); 
            gap: 12px;
            /* 限制最大寬度並用 margin: 0 auto 置中，避免視覺上偏右 */
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            padding: 0;
            box-sizing: border-box;
            /* 防止觸控縮放 */
            touch-action: manipulation;
            /* 讓整個 grid 區塊在容器中水平置中 */
            justify-content: center;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .memory-game {
                gap: 10px;
            }
        }
        
        @media (max-width: 360px) {
            .memory-game {
                gap: 8px;
            }
        }

        .memory-card {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 15px;
            cursor: pointer;
            transition: box-shadow 0.3s ease, border 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: 3px solid transparent;
            box-sizing: border-box;
            /* 防止觸控縮放 - 關鍵設定 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            /* 防止任何形式的縮放 */
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* 移除手機版的 hover 效果，只在桌面版啟用 */
        @media (hover: hover) and (pointer: fine) {
            .memory-card:hover {
                box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            }
        }

        .memory-card.selected {
            /* 不使用 transform: scale，改用邊框和陰影來表示選中狀態 */
            box-shadow: 0 0 20px 5px rgba(121, 85, 72, 0.3);
            border: 3px solid #C8A987;
            opacity: 0.9;
        }

        @keyframes spin-animation {
            from { 
                transform: perspective(1000px) rotateY(0deg); 
            }
            to { 
                transform: perspective(1000px) rotateY(360deg); 
            }
        }

        .memory-card.is-spinning {
            animation: spin-animation 1s ease-in-out;
            /* 確保動畫不會觸發頁面縮放 */
            transform-origin: center center;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .memory-card .icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
        }

        .memory-card .icon svg {
            width: 70%; 
            height: 70%;
        }
        
        [data-card="moon-pink"] { background-color: #F8DCDA; }
        [data-card="moon-pink"] svg { fill: #F7D94C; }
        [data-card="star-green"] { background-color: #F9F3D0; }
        [data-card="star-green"] svg { fill: #2C9D5D; }
        [data-card="star-blue"] { background-color: #D9E2E0; }
        [data-card="star-blue"] svg { fill: #255A81; }
        [data-card="tennis-ball"] { background-color: #C9D8C5; }
        [data-card="tennis-ball"] svg { fill: #97B53F; }
        [data-card="sun-red"] { background-color: #D9E2E0; }
        [data-card="heart-red"] { background-color: #F8DCDA; }
        [data-card="heart-red"] svg { fill: #E84A28; }

        .controls {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 0;
        }

        .btn {
            background: #EACDA3;
            color: white;
            border: none;
            padding: 16px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
            width: 100%;
            max-width: 100%;
            letter-spacing: 2px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            /* 防止觸控縮放 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .btn {
                font-size: 1.1em;
                padding: 14px 25px;
                letter-spacing: 1.5px;
            }
        }

        /* 只在桌面版啟用 hover 效果 */
        @media (hover: hover) and (pointer: fine) {
            .btn:hover {
                box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            }
        }
        
        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(80, 70, 60, 0.6); 
            backdrop-filter: blur(5px);
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
            opacity: 0; 
            transition: opacity 0.3s ease; 
            padding: 20px;
            /* 防止觸控縮放 */
            touch-action: manipulation;
        }
        .modal.show { display: flex; opacity: 1; }
        
        /* 手機版優化 */
        @media (max-width: 480px) {
            .modal {
                padding: 15px;
            }
        }
        .modal-content {
            background: var(--modal-bg); border-radius: 25px; padding: 25px 30px 30px;
            max-width: 480px; width: 100%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative; text-align: center;
            /* 防止觸控縮放和優化渲染 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            will-change: transform;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal-icon {
            width: 120px; height: 120px; margin: -20px auto 20px;
            background-color: var(--modal-accent);
            -webkit-mask-image: url(slogo.png); mask-image: url(slogo.png);
            -webkit-mask-size: contain; mask-size: contain;
            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            -webkit-mask-position: center; mask-position: center;
        }
        .modal-header h3 {
            font-size: 26px; color: var(--modal-title-text);
            font-weight: bold; margin-bottom: 25px;
        }
        .modal-message-container {
            font-size: 20px; line-height: 1.8; color: var(--modal-text);
            text-align: center; margin-bottom: 30px; padding: 25px;
            background: var(--modal-content-bg); border: 1px solid var(--modal-border);
            border-radius: 15px;
        }
        .modal-button {
            background: var(--modal-accent); color: white;
            border: none; padding: 16px 50px; font-size: 18px; font-weight: bold;
            border-radius: 50px; cursor: pointer; width: 100%; max-width: 300px;
            display: block; margin: 0 auto; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
            /* 防止觸控縮放 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 只在桌面版啟用 hover 效果 */
        @media (hover: hover) and (pointer: fine) {
            .modal-button:hover {
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            }
        }

    </style>
</head>
<body>

    <div class="snow-container" id="snow-container"></div>

    <!-- SVG Icon Definitions -->
    <svg width="0" height="0" style="position:absolute;z-index:-1;">
        <defs>
            <symbol id="icon-moon" viewBox="0 0 100 100"><path d="M 95,50 A 45,45 0 1,1 50,5 A 30,30 0 1,0 95,50 Z" /></symbol>
            <symbol id="icon-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,96 50,75 21,96 32,62 2,40 39,40" /></symbol>
            <symbol id="icon-tennis" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" stroke-width="0"/><path d="M 15,35 C 40,65 60,45 85,75" stroke-width="8" stroke="white" fill="none" /></symbol>
            <symbol id="icon-sun" viewBox="0 0 100 100"><g fill="#E84A28"><g stroke="#E84A28" stroke-width="7" stroke-linecap="round"><line x1="50" y1="22" x2="50" y2="7"/><line x1="70" y1="30" x2="82" y2="18"/><line x1="78" y1="50" x2="93" y2="50"/><line x1="70" y1="70" x2="82" y2="82"/><line x1="50" y1="78" x2="50" y2="93"/><line x1="30" y1="70" x2="18" y2="82"/><line x1="22" y1="50" x2="7" y2="50"/><line x1="30" y1="30" x2="18" y2="18"/></g><circle cx="47" cy="48" r="23"/><circle cx="53" cy="52" r="23"/></g></symbol>
            <symbol id="icon-heart" viewBox="0 0 100 100"><path fill="#E84A28" d="M50,30 C20,0 0,25 0,45 C0,75 50,100 50,100 C50,100 100,75 100,45 C100,25 80,0 50,30 Z"/></symbol>
            <symbol id="icon-sparkle" viewBox="0 0 100 100"><path d="M50 0 L61.2 38.8 L100 50 L61.2 61.2 L50 100 L38.8 61.2 L0 50 L38.8 38.8 Z" /></symbol>
        </defs>
    </svg>

    <div class="main-wrapper">
        <div class="game-container">
            <h1>
                <svg class="title-icon"><use xlink:href="#icon-sparkle"></use></svg>
                <span>點點心連心</span>
                <svg class="title-icon"><use xlink:href="#icon-sparkle"></use></svg>
            </h1>
            <p class="instructions">點選二張與你心相連的顏色牌卡吧！</p>
            <div class="memory-game" id="gameBoard"></div>
        </div>
        <div class="controls">
            <button class="btn" onclick="resetGame()">2026寒修行</button>
        </div>
    </div>

    <div class="modal" id="guidanceModal">
        <div class="modal-content">
            <div class="modal-icon"></div>
            <div class="modal-header"><h3 id="modalTitle"></h3></div>
            <div class="modal-message-container" id="guidanceMessage"></div>
            <button class="modal-button" id="closeModalBtn">立馬前行GOGOGO</button>
        </div>
    </div>

    <script>
        const gameBoard = document.getElementById('gameBoard');
        const modal = document.getElementById('guidanceModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTitleEl = document.getElementById('modalTitle');
        const guidanceMessageEl = document.getElementById('guidanceMessage');

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSmsbivmJSOlSU040kBg0FLr7MglWgV8GFGBpRBuCRah36LH__sp8fgfzHiASonM5d74ysM7qIY9EbL/pub?gid=0&single=true&output=csv';
        let mahayanaData = [];

        const cardArray = [
            { name: 'star-green', svgId: 'icon-star' }, { name: 'moon-pink', svgId: 'icon-moon' },
            { name: 'heart-red', svgId: 'icon-heart' }, { name: 'sun-red', svgId: 'icon-sun' },
            { name: 'tennis-ball', svgId: 'icon-tennis' }, { name: 'star-blue', svgId: 'icon-star' },
            { name: 'star-green', svgId: 'icon-star' }, { name: 'star-blue', svgId: 'icon-star' },
            { name: 'moon-pink', svgId: 'icon-moon' }, { name: 'heart-red', svgId: 'icon-heart' },
            { name: 'sun-red', svgId: 'icon-sun' }, { name: 'tennis-ball', svgId: 'icon-tennis' },
            { name: 'star-blue', svgId: 'icon-star' }, { name: 'star-green', svgId: 'icon-star' },
            { name: 'moon-pink', svgId: 'icon-moon' }, { name: 'star-blue', svgId: 'icon-star' }
        ];

        let selectedCards = [];
        let lockBoard = false;
        let isGameActive = true; 

        async function loadSheetData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('網路回應錯誤');
                const csvText = await response.text();
                const messages = csvText.split('\n').slice(1).map(line => line.trim().replace(/^"|"$/g, '')).filter(line => line);
                if (messages.length > 0) { mahayanaData = messages; } else { throw new Error('CSV 檔案為空'); }
            } catch (error) {
                console.error('資料載入失敗:', error);
                mahayanaData = ["(提醒) 資料載入失敗，請檢查網路連線。", "(祝福) 願您的每一天都充滿平靜與喜悅。"];
            }
        }

        function shuffle(array) { array.sort(() => 0.5 - Math.random()); }

        function createBoard() {
            shuffle(cardArray);
            gameBoard.innerHTML = '';
            cardArray.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('memory-card');
                const iconDiv = document.createElement('div');
                iconDiv.classList.add('icon');
                iconDiv.dataset.card = item.name;
                iconDiv.innerHTML = `<svg><use xlink:href="#${item.svgId}"></use></svg>`;
                card.appendChild(iconDiv);
                
                // 修改點擊事件處理，防止任何可能的縮放
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleCardClick(card);
                });
                
                // 防止觸控開始時的默認行為
                card.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                }, { passive: true });
                
                gameBoard.appendChild(card);
            });
        }
        
        function handleCardClick(card) {
            if (lockBoard || selectedCards.length >= 2 || card.classList.contains('selected')) return;
            card.classList.add('selected');
            selectedCards.push(card);
            if (selectedCards.length === 2) { lockBoard = true; setTimeout(showGuidance, 500); }
        }
        
        function showGuidance() {
            isGameActive = false; 
            if (mahayanaData.length < 1) {
                modalTitleEl.textContent = '提醒';
                guidanceMessageEl.textContent = '資料不足，無法提供指引。';
            } else {
                const randomMessage = mahayanaData[Math.floor(Math.random() * mahayanaData.length)];
                const match = randomMessage.match(/\(([^)]+)\)(.*)/s); 
                if (match && match[1] && match[2]) {
                    modalTitleEl.textContent = `(摘錄自) ${match[1].trim()}`;
                    guidanceMessageEl.innerHTML = match[2].trim().replace(/\n/g, '<br>');
                } else {
                    modalTitleEl.textContent = '修行指引';
                    guidanceMessageEl.innerHTML = randomMessage.trim().replace(/\n/g, '<br>');
                }
            }
            modal.classList.add('show');
        }

        function closeModal() { modal.classList.remove('show'); setTimeout(resetGame, 300); }

        function resetGame() {
            selectedCards.forEach(card => card.classList.remove('selected'));
            selectedCards = [];
            lockBoard = false;
            isGameActive = true; 
        }

        function createSnowflakes() {
            const container = document.getElementById('snow-container');
            if (!container) return;
            const snowflakeCount = 100;
            let snowflakesHTML = '';
            for (let i = 0; i < snowflakeCount; i++) {
                const size = Math.random() * 4 + 2;
                const left = Math.random() * 100;
                const duration = Math.random() * 10 + 10;
                const delay = Math.random() * 15;
                snowflakesHTML += `<div class="snowflake" style="width:${size}px; height:${size}px; left:${left}%; animation-duration:${duration}s; animation-delay:${delay}s;"></div>`;
            }
            container.innerHTML = snowflakesHTML;
        }

        function animateRandomCards() {
            if (!isGameActive) return; 

            const cards = document.querySelectorAll('.memory-card');
            if (cards.length < 2) return;

            let index1 = Math.floor(Math.random() * cards.length);
            let index2;
            do {
                index2 = Math.floor(Math.random() * cards.length);
            } while (index1 === index2);

            const card1 = cards[index1];
            const card2 = cards[index2];

            card1.classList.add('is-spinning');
            card2.classList.add('is-spinning');

            setTimeout(() => {
                card1.classList.remove('is-spinning');
                card2.classList.remove('is-spinning');
            }, 1000); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            createBoard();
            loadSheetData();
            createSnowflakes();
            setInterval(animateRandomCards, 3000);
            
            // === 修正 3：全面的觸控縮放防止機制 ===
            
            // 1. 防止雙擊縮放（加強版）
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                lastTouchEnd = now;
            }, { passive: false });
            
            // 2. 防止手勢縮放
            document.addEventListener('gesturestart', function (event) {
                event.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gesturechange', function (event) {
                event.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gestureend', function (event) {
                event.preventDefault();
            }, { passive: false });
            
            // 3. 防止滾輪縮放
            document.addEventListener('wheel', function(event) {
                if (event.ctrlKey) {
                    event.preventDefault();
                }
            }, { passive: false });
            
            // 4. 防止觸控移動時的縮放
            let touchStartDistance = 0;
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                    const touch1 = event.touches[0];
                    const touch2 = event.touches[1];
                    touchStartDistance = Math.hypot(
                        touch2.pageX - touch1.pageX,
                        touch2.pageY - touch1.pageY
                    );
                }
            }, { passive: false });
            
            document.addEventListener('touchmove', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, { passive: false });
            
            // 5. 阻止視窗大小變化（某些瀏覽器的縮放會觸發）
            let lastWidth = window.innerWidth;
            let lastHeight = window.innerHeight;
            window.addEventListener('resize', function() {
                const newWidth = window.innerWidth;
                const newHeight = window.innerHeight;
                
                // 如果是明顯的縮放（而非旋轉），嘗試重置視窗
                if (Math.abs(newWidth - lastWidth) > 50 || Math.abs(newHeight - lastHeight) > 50) {
                    // 記錄但不做任何會影響布局的事情
                    console.log('Window size changed significantly');
                }
                
                lastWidth = newWidth;
                lastHeight = newHeight;
            });
            
            // 6. 強制禁用所有可能的縮放相關事件
            ['touchstart', 'touchmove', 'touchend'].forEach(eventType => {
                document.body.addEventListener(eventType, function(e) {
                    if (e.touches && e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    </script>
</body>
</html>
